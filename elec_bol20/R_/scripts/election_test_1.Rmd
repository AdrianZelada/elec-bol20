---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
library(data.table)
library(here)
library(stringr)
```


```{r}
dir(here::here())
dir(paste0(here::here(),"/../datos_0_crudos/2019"))

dat_2019_final = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/final_comp.csv"), 
                          colClasses = "character")
  
```

```{r}
clean_headers = function(headervec){
  temp = headervec %>%
    gsub("Ãº","u",.)
  temp = gsub("Ã³","o",temp)
  temp = gsub("Ã¡","a",temp)
  temp = gsub("Ã","i",temp)
  temp = gsub(" ","_",temp)
  return(temp)
}
#names(dat_2019_final)

names(dat_2019_final)=clean_headers(names(dat_2019_final))
head(dat_2019_final)

dat_2019_final = dat_2019_final%>%
  mutate_at(c("Inscritos","CC","MAS...IPSP","PDC","Votos.Vi.lidos","Blancos","Nulos"), as.numeric)
```
```{r}
get_perc = function(vec, totvec){
  return(vec/totvec*100)
}

#checking the end result
quickcheck = dat_2019_final %>%
  dplyr::summarise(MAS_tot = sum(MAS...IPSP,na.rm=T),
                   CC_tot = sum(CC,na.rm=T),
                   validos_tot = sum(Votos.Vi.lidos,na.rm=T))%>%
  dplyr::mutate_at(c("MAS_tot","CC_tot"), .funs = list(perc = ~ get_perc(.,validos_tot)))

quickcheck


nrow(dat_2019_final)
length(unique(dat_2019_final$Codigo.Mesa))
```


```{r}
dat_2019_cluster = dat_2019_final %>%
  #select("Numero_Mesa", "CC", "MAS_-_IPSP","PDC", "Votos_Validos")%>%
  arrange(Numero.Mesa)

any(duplicated(dat_2019_cluster$Numero.Mesa))
any(duplicated(dat_2019_cluster$Codigo.Mesa))
```
```{r}
get_perc = function(vec, totvec){
  return(vec/totvec*100)
}

Inf_to_NA = function(vec){
  out = ifelse(is.infinite(vec),NA,vec)
  return(out)
}
# 
# dat_2019_recinto.s = dat_2019_final %>%
#   dplyr::group_by(id_rec)%>%
#   dplyr::summarise_at(c("CC","MAS...IPSP", "PDC", "Votos.Vi.lidos","Blancos","Nulos"), .funs = sum)%>%
#   mutate_at(c("CC","MAS...IPSP", "PDC", "Votos.Vi.lidos"), .funs = list(perc =~ get_perc(.,Votos.Vi.lidos)))

```

```{r}
dat_2019_final_m = dat_2019_final %>%
  mutate_at(c("CC","MAS...IPSP", "PDC", "Votos.Vi.lidos"), .funs = list(perc =~ get_perc(.,Votos.Vi.lidos)))


cluster_and_bind = function(dataframe, IDcolumn, usecols, nclusters){
  myframe = dataframe %>%
    dplyr::rename("IDcol"=IDcolumn)
  
  myframe = myframe %>%
    arrange(IDcol)%>%
    dplyr::select(c(IDcol,usecols))%>%
    mutate_all(Inf_to_NA)%>%
    na.omit()
  
  mymatrix = myframe %>%
    dplyr::select(usecols)%>%
    as.matrix()
  
  kmeans_output = kmeans(mymatrix, nclusters)
  outframe = data.frame(IDcol = myframe$IDcol, cluster = kmeans_output$cluster)
  names(outframe)[1] = IDcolumn

  return(list(kmeans_output, outframe))
}#cluster_and_bind
```

```{r}
cluster_results= cluster_and_bind(dat_2019_final_m, "Codigo.Mesa", 
                                     c("CC_perc","MAS...IPSP_perc", "PDC_perc"),10)
cluster_mask = cluster_results[[2]]


dat_2019_trep = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/percentil_trep.csv"),
                         colClasses = "character")%>%
  dplyr::rename("Codigo.Mesa"=CÃ³digo.Mesa)

dat_2019_comp = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/percentil_trep.csv"),
                         colClasses = "character")%>%
  dplyr::rename("Codigo.Mesa"=CÃ³digo.Mesa)

dat_2019_combined = dplyr::full_join(cluster_mask, dat_2019_trep, by = "Codigo.Mesa" )%>%
  dplyr::full_join(.,dat_2019_final_m, by = "Codigo.Mesa" )


total_by_cluster = dat_2019_combined %>%
  dplyr::group_by(cluster)%>%
  dplyr::summarise(habilitados = sum(Inscritos),
                   validos = sum(Votos.Vi.lidos))%>%
  na.omit()

````

```{r}
predict_from_percentage = function(clusterperc, total_habilitados){
  return(clusterperc/100*total_habilitados)
}

mytest = dat_2019_combined %>%
  dplyr::filter(pj < 20)%>%
  dplyr::group_by(cluster)%>%
  dplyr::summarise_at(c("CC_perc","MAS...IPSP_perc","PDC_perc"),
                      .funs = list(mean =~ mean(.,na.rm=T),
                                   sd = ~ sd(.,na.rm=T),
                                   sterr = ~ sd(.,na.rm=T)/sqrt(sum(!is.na(.)))))


myprediction = dplyr::full_join(total_by_cluster,mytest,by="cluster")%>%
  na.omit()%>%
  mutate_at(vars(contains("mean")), .funs = list(predicted_votes = ~ predict_from_percentage(., habilitados)))%>%
  dplyr::select(contains("predicted_votes"))%>%
  dplyr::summarise_all(sum)

myprediction = myprediction/allvotes
myprediction
```

```{r}
# mesa_data = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/estad_nac.csv"),skip=0)
# 
# mesa_data_comb = dplyr::full_join(mesa_data, cluster_mask, by = "Codigo.Mesa")
```





```{r}


dat_2019_cluster = dat_2019_cluster %>%
  arrange(Numero_Mesa)%>%
  mutate(perc_MAS = `MAS_-_IPSP`/Votos_Validos*100,
         perc_CC = CC/Votos_Validos*100,
         perc_PDC = PDC/Votos_Validos*100,
         mydif_mas_cc = perc_MAS - perc_CC) %>%
  na.omit()

mesa_vector = dat_2019_cluster$Numero_Mesa #later combined with the cluster vector to merge back

dat_2019_cluster_2 = dat_2019_cluster %>%
  dplyr::select(perc_MAS, perc_CC, perc_PDC) %>%
  as.matrix()

```

```{r}
wssplot <- function(data, nc=15, seed=123){
               wss <- (nrow(data)-1)*sum(apply(data,2,var))
               for (i in 2:nc){
                    set.seed(seed)
                    wss[i] <- sum(kmeans(data, centers=i)$withinss)}
                plot(1:nc, wss, type="b", xlab="Number of groups",
                     ylab="Sum of squares within a group")}

wssplot(dat_2019_cluster_2, nc = 20)


```
# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 3)
# 
# library(cluster)
# library(factoextra)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```

# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 4)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```
# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 10)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```

# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 7)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```

# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 6)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```

```{r}
kmeans_output = kmeans(dat_2019_cluster_2, 10)

clustered_mask = data.frame(cluster=kmeans_output$cluster,Numero_Mesa = mesa_vector )

dat_2019_clustered = dplyr::full_join(dat_2019_cluster, clustered_mask, by = "Numero_Mesa")

write.csv( dat_2019_clustered,
           file=paste0(here::here(),"/../datos_1_intermedios/2019/2019_final_comp_clustered_6.csv"))
```

```{r}
plotdata = kmeans_output$centers %>%
  as.data.frame()%>%
  mutate(cluster = 1:nrow(kmeans_output$centers))%>%
  gather(key = "what", value = "percentage", 1:3)

ggplot(plotdata,aes(x=cluster, y = percentage, fill = what))+
  geom_col(position = position_dodge())+
  scale_x_continuous(breaks=1:12)

plotdata = dat_2019_clustered %>%
  dplyr::select(cluster, perc_MAS, perc_CC, perc_PDC)%>%
  gather(key = "what", value = "percentage", 2:4)%>%
  mutate(cluster=factor(cluster))

ggplot(plotdata, aes(x=what, y=percentage, fill=cluster))+
  geom_boxplot(notch = TRUE)

ggplot(plotdata, aes(x=cluster, y=percentage, fill=what))+
  geom_boxplot(notch = TRUE, width=0.5)

```

