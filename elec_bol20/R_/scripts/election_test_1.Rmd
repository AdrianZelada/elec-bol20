---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
library(data.table)
library(here)
library(stringr)
```


```{r}
dir(here::here())
dir(paste0(here::here(),"/../datos_0_crudos/2019"))

dat_2019_final = fread(paste0(here::here(),"/../datos_0_crudos/2019/final_comp.csv"))

```

```{r}
clean_headers = function(headervec){
  temp = headervec %>%
    gsub("Ãº","u",.)
  temp = gsub("Ã³","o",temp)
  temp = gsub("Ã¡","a",temp)
  temp = gsub("Ã","i",temp)
  temp = gsub(" ","_",temp)
  return(temp)
}
#names(dat_2019_final)

names(dat_2019_final)=clean_headers(names(dat_2019_final))
head(dat_2019_final)
```

```{r}
dat_2019_cluster = dat_2019_final %>%
  #select("Numero_Mesa", "CC", "MAS_-_IPSP","PDC", "Votos_Validos")%>%
  arrange(Numero_Mesa)

any(duplicated(dat_2019_cluster$Numero_Mesa))
```

```{r}
dat_2019_cluster = dat_2019_cluster %>%
  arrange(Numero_Mesa)%>%
  mutate(perc_MAS = `MAS_-_IPSP`/Votos_Validos*100,
         perc_CC = CC/Votos_Validos*100,
         perc_PDC = PDC/Votos_Validos*100,
         mydif_mas_cc = perc_MAS - perc_CC) %>%
  na.omit()

mesa_vector = dat_2019_cluster$Numero_Mesa #later combined with the cluster vector to merge back

dat_2019_cluster_2 = dat_2019_cluster %>%
  dplyr::select(perc_MAS, perc_CC, perc_PDC) %>%
  as.matrix()

```

```{r}
wssplot <- function(data, nc=15, seed=123){
               wss <- (nrow(data)-1)*sum(apply(data,2,var))
               for (i in 2:nc){
                    set.seed(seed)
                    wss[i] <- sum(kmeans(data, centers=i)$withinss)}
                plot(1:nc, wss, type="b", xlab="Number of groups",
                     ylab="Sum of squares within a group")}

wssplot(dat_2019_cluster_2, nc = 20)


```
# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 3)
# 
# library(cluster)
# library(factoextra)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```

# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 4)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```
# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 10)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```

# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 7)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```

# ```{r}
# kmeans_output = kmeans(dat_2019_cluster_2, 6)
# 
# sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2))
# fviz_silhouette(sil)
# ```

```{r}
kmeans_output = kmeans(dat_2019_cluster_2, 6)

clustered_mask = data.frame(cluster=kmeans_output$cluster,Numero_Mesa = mesa_vector )

dat_2019_clustered = dplyr::full_join(dat_2019_cluster, clustered_mask, by = "Numero_Mesa")

write.csv( dat_2019_clustered,
           file=paste0(here::here(),"/../datos_1_intermedios/2019/2019_final_comp_clustered_6.csv"))
```

```{r}
plotdata = kmeans_output$centers %>%
  as.data.frame()%>%
  mutate(cluster = 1:nrow(kmeans_output$centers))%>%
  gather(key = "what", value = "percentage", 1:3)

ggplot(plotdata,aes(x=cluster, y = percentage, fill = what))+
  geom_col(position = position_dodge())+
  scale_x_continuous(breaks=1:12)

plotdata = dat_2019_clustered %>%
  dplyr::select(cluster, perc_MAS, perc_CC, perc_PDC)%>%
  gather(key = "what", value = "percentage", 2:4)%>%
  mutate(cluster=factor(cluster))

ggplot(plotdata, aes(x=what, y=percentage, fill=cluster))+
  geom_boxplot(notch = TRUE)

ggplot(plotdata, aes(x=cluster, y=percentage, fill=what))+
  geom_boxplot(notch = TRUE, width=0.5)

```

