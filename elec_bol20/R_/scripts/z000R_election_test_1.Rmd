---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

```{r}
library(tidyverse)
library(data.table)
library(here)
library(stringr)
```


```{r}
rename_vector = c("MAS...IPSP" = "MAS",
                  "CC" = "CC",
                  "Votos.VÃ.lidos"="VV",
                  "total_votes"="VT",
                  "Blancos" = "BL",
                  "Nulos" = "NL",
                  "NÃºmero.Mesa" = "N_MESAS",
                  "CÃ³digo.Mesa" = "ID_MESA",
                  "id_rec" = "ID_RECI",
                  "Inscritos" = "HAB",
                  "latitud" = "LAT",
                  "longitud" = "LON")


dat_2019_final = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/final_comp.csv"), 
                          colClasses = "character")

mesa_info_ext = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/estad_ext.csv"), 
                          colClasses = "character")
mesa_info_nac = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/estad_nac.csv"), 
                          colClasses = "character")



names(dat_2019_final) = plyr::revalue(names(dat_2019_final), rename_vector)
names(mesa_info_ext) = plyr::revalue(names(mesa_info_ext), rename_vector)
names(mesa_info_nac) = plyr::revalue(names(mesa_info_nac), rename_vector)

mesa_info_ext = mesa_info_ext%>%
  dplyr::select(LAT,LON,ID_RECI)

mesa_info_nac = mesa_info_nac%>%
  dplyr::select(LAT,LON,ID_RECI)

mesa_info = rbind(mesa_info_nac, mesa_info_ext)

dat_2019_final = dat_2019_final %>%
  dplyr::mutate_at(c("MAS","CC","PDC","BL","NL","VV", "HAB"), .funs = as.numeric)

```

```{r}
get_perc = function(vec, totvec){
  return(vec/totvec*100)
}

#checking the end result
end_result = dat_2019_final %>%
  dplyr::summarise(MAS_tot = sum(MAS,na.rm=T),
                   CC_tot = sum(CC,na.rm=T),
                   validos_tot = sum(VV,na.rm=T))%>%
  dplyr::mutate_at(c("MAS_tot","CC_tot"), .funs = list(perc = ~ get_perc(.,validos_tot)))

end_result

#some tests
nrow(dat_2019_final)
length(unique(dat_2019_final$ID_MESA))

allvotes = sum(dat_2019_final$HAB)
```

```{r}
cluster_and_bind = function(dataframe, IDcolumn, usecols, nclusters){
  # dataframe : (dataframe) containing the data to be clustered
  # IDcolumn : (string) name of the column serving as ID for an entry. For example: N_MESA
  # usecols : (string) name of all data columns (not the ID) to be considered for the clustering
  # nclusters : (int) number of clusters to be producted
  
  # output : (list). First element is the direct result of the k-means. Second element is a dataframe containing only the IDcolumn and the assigned cluster (sort of a mask)
  Inf_to_NA = function(vec){
    out = ifelse(is.infinite(vec),NA,vec)
    return(out)
  }
  
  myframe = dataframe %>%
    dplyr::rename("IDcol"=IDcolumn)
  
  myframe = myframe %>%
    arrange(IDcol)%>%
    dplyr::select(c(IDcol,usecols))%>%
    mutate_all(Inf_to_NA)%>% #this and the following column ensures that there is no Inf or NA value in the data, because then kmeans fails.
    na.omit()#
  
  mymatrix = myframe %>%
    dplyr::select(usecols)%>%
    as.matrix()
  
  kmeans_output = kmeans(mymatrix, nclusters)
  outframe = data.frame(IDcol = myframe$IDcol, cluster = kmeans_output$cluster)
  names(outframe)[1] = IDcolumn

  return(list(kmeans_output, outframe))
}#cluster_and_bind
```

```{r}
dat_2019_final_m = dat_2019_final %>%
  mutate_at(c("CC","MAS", "PDC", "VV"), .funs = list(perc =~ get_perc(.,VV)))
names(dat_2019_final_m) = plyr::revalue(names(dat_2019_final_m),
                                              c("MAS_perc" = "mas",
                                                "CC_perc" = "cc",
                                                "PDC_perc" = "pdc"))


cluster_results = cluster_and_bind(dat_2019_final_m, "ID_MESA", 
                                     c("cc","mas", "pdc","BL","NL"),10)
cluster_mask = cluster_results[[2]]

#####output here
clustermask_out = cluster_mask %>%
  dplyr::mutate(ID_RECI = substr(as.character(ID_MESA),1,16))%>%
  dplyr::full_join(., mesa_info, by = "ID_RECI")%>%
  dplyr::select(ID_MESA, LAT, LON, cluster)

```

```{r}
#some more data inport for testing
dat_2019_trep = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/percentil_trep.csv"),
                         colClasses = "character")%>%
  dplyr::rename("ID_MESA"=CÃ³digo.Mesa)

dat_2019_comp = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/percentil_trep.csv"),
                         colClasses = "character")%>%
  dplyr::rename("ID_MESA"=CÃ³digo.Mesa)
##

dat_2019_combined = dplyr::full_join(cluster_mask, dat_2019_trep, by = "ID_MESA" )%>%
  dplyr::full_join(.,dat_2019_final_m, by = "ID_MESA")


total_by_cluster = dat_2019_combined %>%
  dplyr::group_by(cluster)%>%
  dplyr::summarise(habilitados = sum(HAB),
                   validos = sum(VV))%>%
  na.omit()

````

```{r}
predict_by_cluster = function(vote_data, mesa_info, cluster_def, identifier){
  #total habilitados for all votes.
  allvotes = sum(mesa_info$HAB)
  
  #getting total habilitados by mesa
  total_by_cluster = dplyr::full_join(mesa_info, cluster_def, by = identifier) %>%
    dplyr::group_by(cluster)%>%
    dplyr::summarise_at(c("HAB","VV"),.funs = sum)%>%
    na.omit()
  
  #combining
  mydata_combined = dplyr::full_join(vote_data, cluster_def, by = identifier)
  
  #getting the mean (along with sd and standard error) vote for already counted clusters
  cluster_mean_vote = mydata_combined %>%
    dplyr::group_by(cluster)%>%
    dplyr::summarise_at(c("cc","mas","pdc"),
                        .funs = list(mean =~ mean(.,na.rm=T),
                                     sd = ~ sd(.,na.rm=T),
                                     sterr = ~ sd(.,na.rm=T)/sqrt(sum(!is.na(.)))))%>%
    na.omit()
  
  #help functions
  predict_from_percentage = function(clusterperc, total_habilitados){
    return(clusterperc/100*total_habilitados)
  }
  error_propagation = function(vec){
    return(sqrt(vec^2))
  }
  
  #end result prediction.
  myprediction = dplyr::full_join(total_by_cluster,cluster_mean_vote,by="cluster")%>%
    na.omit()%>%
    mutate_at(vars(contains("mean")), 
              .funs = list(pred = ~ predict_from_percentage(., HAB)))%>%
    dplyr::select(contains("mean_pred"))%>%
    dplyr::summarise_all(sum)
  
  myprediction = myprediction/allvotes
  
  return(cluster_mean_vote)
}
test = predict_by_cluster(dat_2019_final_m, dat_2019_final, cluster_mask, "ID_MESA")
```



```{r}



predict_from_percentage = function(clusterperc, total_habilitados){
  return(clusterperc/100*total_habilitados)
}

cluster_mean_vote = dat_2019_combined %>%
  dplyr::filter(pj < 20)%>%
  dplyr::group_by(cluster)%>%
  dplyr::summarise_at(c("cc","mas","pdc"),
                      .funs = list(mean =~ mean(.,na.rm=T),
                                   sd = ~ sd(.,na.rm=T),
                                   sterr = ~ sd(.,na.rm=T)/sqrt(sum(!is.na(.)))))


myprediction = dplyr::full_join(total_by_cluster,cluster_mean_vote,by="cluster")%>%
  na.omit()%>%
  mutate_at(vars(contains("mean")), .funs = list(predicted_votes = ~ predict_from_percentage(., habilitados)))%>%
  dplyr::select(contains("predicted_votes"))%>%
  dplyr::summarise_all(sum)

myprediction = myprediction/allvotes
myprediction
```

```{r}
# mesa_data = read.csv(paste0(here::here(),"/../datos_0_crudos/2019/estad_nac.csv"),skip=0)
# 
# mesa_data_comb = dplyr::full_join(mesa_data, cluster_mask, by = "ID_MESA")
```





<!-- ```{r} -->


<!-- dat_2019_cluster = dat_2019_cluster %>% -->
<!--   arrange(ID_MESA)%>% -->
<!--   mutate(perc_MAS = `MAS_-_IPSP`/Votos_Validos*100, -->
<!--          perc_CC = CC/Votos_Validos*100, -->
<!--          perc_PDC = PDC/Votos_Validos*100, -->
<!--          mydif_mas_cc = perc_MAS - perc_CC) %>% -->
<!--   na.omit() -->

<!-- mesa_vector = dat_2019_cluster$Numero_Mesa #later combined with the cluster vector to merge back -->

<!-- dat_2019_cluster_2 = dat_2019_cluster %>% -->
<!--   dplyr::select(perc_MAS, perc_CC, perc_PDC) %>% -->
<!--   as.matrix() -->

<!-- ``` -->

<!-- ```{r} -->
<!-- wssplot <- function(data, nc=15, seed=123){ -->
<!--                wss <- (nrow(data)-1)*sum(apply(data,2,var)) -->
<!--                for (i in 2:nc){ -->
<!--                     set.seed(seed) -->
<!--                     wss[i] <- sum(kmeans(data, centers=i)$withinss)} -->
<!--                 plot(1:nc, wss, type="b", xlab="Number of groups", -->
<!--                      ylab="Sum of squares within a group")} -->

<!-- wssplot(dat_2019_cluster_2, nc = 20) -->


<!-- ``` -->
<!-- # ```{r} -->
<!-- # kmeans_output = kmeans(dat_2019_cluster_2, 3) -->
<!-- #  -->
<!-- # library(cluster) -->
<!-- # library(factoextra) -->
<!-- #  -->
<!-- # sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2)) -->
<!-- # fviz_silhouette(sil) -->
<!-- # ``` -->

<!-- # ```{r} -->
<!-- # kmeans_output = kmeans(dat_2019_cluster_2, 4) -->
<!-- #  -->
<!-- # sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2)) -->
<!-- # fviz_silhouette(sil) -->
<!-- # ``` -->
<!-- # ```{r} -->
<!-- # kmeans_output = kmeans(dat_2019_cluster_2, 10) -->
<!-- #  -->
<!-- # sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2)) -->
<!-- # fviz_silhouette(sil) -->
<!-- # ``` -->

<!-- # ```{r} -->
<!-- # kmeans_output = kmeans(dat_2019_cluster_2, 7) -->
<!-- #  -->
<!-- # sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2)) -->
<!-- # fviz_silhouette(sil) -->
<!-- # ``` -->

<!-- # ```{r} -->
<!-- # kmeans_output = kmeans(dat_2019_cluster_2, 6) -->
<!-- #  -->
<!-- # sil <- silhouette(kmeans_output$cluster, dist(dat_2019_cluster_2)) -->
<!-- # fviz_silhouette(sil) -->
<!-- # ``` -->

<!-- ```{r} -->
<!-- kmeans_output = kmeans(dat_2019_cluster_2, 10) -->

<!-- clustered_mask = data.frame(cluster=kmeans_output$cluster,Numero_Mesa = mesa_vector ) -->

<!-- dat_2019_clustered = dplyr::full_join(dat_2019_cluster, clustered_mask, by = "Numero_Mesa") -->

<!-- write.csv( dat_2019_clustered, -->
<!--            file=paste0(here::here(),"/../datos_1_intermedios/2019/2019_final_comp_clustered_6.csv")) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- plotdata = kmeans_output$centers %>% -->
<!--   as.data.frame()%>% -->
<!--   mutate(cluster = 1:nrow(kmeans_output$centers))%>% -->
<!--   gather(key = "what", value = "percentage", 1:3) -->

<!-- ggplot(plotdata,aes(x=cluster, y = percentage, fill = what))+ -->
<!--   geom_col(position = position_dodge())+ -->
<!--   scale_x_continuous(breaks=1:12) -->

<!-- plotdata = dat_2019_clustered %>% -->
<!--   dplyr::select(cluster, perc_MAS, perc_CC, perc_PDC)%>% -->
<!--   gather(key = "what", value = "percentage", 2:4)%>% -->
<!--   mutate(cluster=factor(cluster)) -->

<!-- ggplot(plotdata, aes(x=what, y=percentage, fill=cluster))+ -->
<!--   geom_boxplot(notch = TRUE) -->

<!-- ggplot(plotdata, aes(x=cluster, y=percentage, fill=what))+ -->
<!--   geom_boxplot(notch = TRUE, width=0.5) -->

<!-- ``` -->

```{r}
clean_headers = function(headervec){
  temp = headervec %>%
    gsub("Ãº","u",.)
  temp = gsub("Ã³","o",temp)
  temp = gsub("Ã¡","a",temp)
  temp = gsub("Ã","i",temp)
  temp = gsub(" ","_",temp)
  return(temp)
}#clean headers (not necessary anymore)

dat_2019_final = dat_2019_final%>%
  mutate_at(c("HAB","CC","MAS","PDC","VV","BL","NL"), as.numeric)
```

